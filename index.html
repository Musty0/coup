<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Coup (Dev)</title>
    <style>
      :root{
        --bg0:#070a10;
        --bg1:#0b1020;
        --panel: rgba(10,14,22,.72);
        --card: rgba(255,255,255,.06);
        --line: rgba(255,255,255,.12);
        --ink: #eaf2ff;
        --muted: rgba(234,242,255,.72);
        --good: #2dd4bf;
        --risk: #fb7185;
        --accent: #a78bfa;
        --shadow: 0 14px 40px rgba(0,0,0,.45);
        --radius: 16px;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        color: var(--ink);
        background:
          radial-gradient(900px 520px at 50% -15%, rgba(167,139,250,.18), transparent 62%),
          radial-gradient(900px 520px at 12% 15%, rgba(45,212,191,.10), transparent 60%),
          radial-gradient(900px 520px at 88% 22%, rgba(251,113,133,.08), transparent 60%),
          linear-gradient(180deg, var(--bg1), var(--bg0));
      }

      /* Top bar */
      .topbar{
        position: sticky; top:0; z-index: 50;
        padding: 10px 12px;
        display:flex; align-items:center; justify-content:space-between; gap:10px;
        background: rgba(0,0,0,.35);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--line);
      }
      .brand{ font-weight: 900; letter-spacing:.4px; display:flex; align-items:baseline; gap:8px; }
      .brand small{ opacity:.6; font-weight:700; }
      .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

      button{
        border: 1px solid var(--line);
        background: rgba(255,255,255,.06);
        color: var(--ink);
        padding: 10px 12px;
        font-size: 16px;
        border-radius: 12px;
      }
      button:disabled{ opacity:.45; }
      .pill{ padding: 7px 10px; border-radius: 999px; font-size: 13px; }
      .primary{ background: rgba(167,139,250,.18); border-color: rgba(167,139,250,.35); }
      .good{ background: rgba(45,212,191,.14); border-color: rgba(45,212,191,.35); }
      .risk{ background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.32); }
      .tiny{ font-size: 13px; }
      .muted{ opacity:.75; }
      .warn{ color: var(--risk); }

      /* Main wrap */
      .wrap{
        max-width: 1120px;
        margin: 0 auto;
        padding: 12px 12px 92px;
      }

      /* Board scene */
      .scene{
        border: 1px solid var(--line);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        background:
          radial-gradient(900px 500px at 50% 40%, rgba(255,255,255,.06), transparent 62%),
          linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
      }

      .sceneHeader{
        padding: 10px 12px;
        display:flex; align-items:center; justify-content:space-between; gap:10px;
        background: rgba(255,255,255,.03);
        border-bottom: 1px solid var(--line);
      }
      .turnPill{
        display:inline-flex; align-items:center; gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(0,0,0,.12);
        font-size: 13px;
      }
      .dot{ width:10px; height:10px; border-radius:999px; background: rgba(234,242,255,.35); }
      .dot.live{ background: rgba(45,212,191,.85); }

      .tableWrap{
        position: relative;
        height: min(74vh, 640px);
        min-height: 520px;
        padding: 14px;
      }

      /* The ‚Äútable‚Äù */
      .table{
        position:absolute;
        left: 50%;
        top: 52%;
        transform: translate(-50%, -50%);
        width: min(680px, 92%);
        height: min(420px, 72%);
        border-radius: 38px;
        background:
          radial-gradient(1200px 500px at 50% 30%, rgba(45,212,191,.06), transparent 60%),
          linear-gradient(180deg, rgba(22,32,46,.9), rgba(12,18,28,.95));
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: inset 0 0 0 10px rgba(0,0,0,.20);
      }

      /* Center deck + pile */
      .centerZone{
        position:absolute;
        left: 50%;
        top: 52%;
        transform: translate(-50%, -50%);
        display:flex;
        flex-direction: column;
        align-items:center;
        gap: 10px;
        pointer-events:none;
      }
      .deckCard{
        width: 68px; height: 92px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.16);
        background:
          linear-gradient(180deg, rgba(167,139,250,.20), rgba(0,0,0,.15)),
          radial-gradient(80px 80px at 50% 35%, rgba(255,255,255,.14), transparent 60%);
        box-shadow: 0 10px 25px rgba(0,0,0,.35);
      }
      .pile{
        display:flex; align-items:center; gap:6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(0,0,0,.12);
        font-size: 13px;
        opacity:.9;
      }

      /* Seats (absolute positions) */
      .seat{
        position:absolute;
        width: 178px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(0,0,0,.18);
        padding: 10px;
        cursor: pointer;
        transition: transform .08s ease, outline-color .12s ease;
        user-select: none;
      }
      .seat:active{ transform: scale(.985); }
      .seat.selected{ outline: 3px solid rgba(167,139,250,.65); }
      .seat.dead{ opacity:.55; filter: grayscale(1); cursor: default; }

      .seatTop{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      }
      .seatName{ font-weight: 900; font-size: 14px; }
      .tag{
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04);
        opacity: .95;
      }

      .seatMeta{
        margin-top: 8px;
        display:flex; align-items:center; justify-content:space-between; gap:8px;
        font-size: 13px;
        opacity: .9;
      }
      .coinStack{
        display:inline-flex; align-items:center; gap:6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04);
      }

      .infs{
        margin-top: 8px;
        display:flex; gap:6px; flex-wrap:wrap;
      }
      .infCard{
        width: 30px; height: 42px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.14);
        display:flex; align-items:center; justify-content:center;
        font-size: 12px;
        background: rgba(255,255,255,.04);
      }
      .infCard.revealed{
        background: rgba(251,113,133,.10);
        border-color: rgba(251,113,133,.25);
        opacity:.95;
      }

      /* ‚ÄúYou‚Äù seat (bigger, bottom) */
      .seat.you{
        width: min(420px, 92%);
        left: 50%;
        bottom: 14px;
        transform: translateX(-50%);
        cursor: default;
        background: rgba(45,212,191,.08);
        border-color: rgba(45,212,191,.22);
      }
      .seat.you:active{ transform: translateX(-50%); }
      .youMetaLine{
        margin-top: 6px;
        display:flex; gap:8px; flex-wrap:wrap; align-items:center;
        font-size: 13px;
        opacity:.9;
      }

      /* Panels area (center overlay, no popups) */
      .panelStack{
        position:absolute;
        left: 50%;
        top: 52%;
        transform: translate(-50%, -50%);
        width: min(540px, 92%);
        z-index: 20;
        pointer-events: none; /* only active panel enables buttons */
      }
      .panel{
        pointer-events: auto;
        border: 1px solid rgba(255,255,255,.12);
        border-radius: 16px;
        padding: 12px;
        background: rgba(0,0,0,.30);
        backdrop-filter: blur(8px);
        box-shadow: 0 14px 40px rgba(0,0,0,.35);
        display:none;
      }
      .panelTitle{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
        margin-bottom: 8px;
      }
      .panelTitle b{ font-size: 14px; }
      #riskHint{ display:none; margin-top:6px; }

      /* Sticky action bar */
      .actionBar{
        position: fixed;
        left: 0; right: 0; bottom: 0;
        z-index: 60;
        padding: 10px 12px;
        background: rgba(0,0,0,.45);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--line);
      }
      .actionInner{
        max-width: 1120px;
        margin: 0 auto;
        display:flex; gap:8px;
        overflow:auto;
        padding-bottom: 4px;
      }
      .actionInner::-webkit-scrollbar{ height: 10px; }
      .actionInner::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }
      .actionInner::-webkit-scrollbar-track{ background: transparent; }

      /* Log drawer */
      #drawer{
        position: fixed;
        left:0; right:0; bottom:0;
        height: 65vh;
        background: rgba(0,0,0,.70);
        border-top: 1px solid var(--line);
        transform: translateY(100%);
        transition: transform .18s ease;
        z-index: 80;
        padding: 12px;
        overflow:auto;
      }
      #drawer.open{ transform: translateY(0%); }
      #drawer .inner{ max-width: 1120px; margin: 0 auto; }
      #log{
        white-space: pre-wrap;
        background: rgba(255,255,255,.04);
        border: 1px solid rgba(255,255,255,.12);
        padding: 10px;
        border-radius: 14px;
      }

      /* Name modal */
      #nameModalBackdrop{
        position: fixed; inset: 0;
        background: rgba(0,0,0,.55);
        display:none;
        align-items:center; justify-content:center;
        padding: 18px;
        z-index: 90;
      }
      #nameModal{
        width: min(520px, 100%);
        background: rgba(0,0,0,.65);
        color: var(--ink);
        border: 1px solid rgba(255,255,255,.14);
        border-radius: 16px;
        padding: 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }
      #nameModal h3{ margin:0 0 8px 0; }
      input{
        padding: 12px 12px;
        font-size: 16px;
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: var(--ink);
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="brand">Coup <small>(dev)</small></div>
      <div class="row">
        <button id="drawerBtn" class="pill">üßæ Log</button>
        <button id="helpBtn" class="pill">Help</button>
        <button id="changeNameBtn" class="pill">Name</button>
        <button id="leaveBtn" class="pill">Leave</button>
      </div>
    </div>

    <div class="wrap">
      <div class="scene">
        <div class="sceneHeader">
          <div class="turnPill">
            <span class="dot" id="liveDot"></span>
            <span id="turn">Connecting‚Ä¶</span>
          </div>
          <div class="tiny muted" id="targetHint">Tap a player to target.</div>
        </div>

        <div class="tableWrap" id="tableWrap">
          <div class="table"></div>

          <div class="centerZone">
            <div class="deckCard" title="Deck"></div>
            <div class="pile" id="centerStatus">ü™ô <b id="meCoinsInline">0</b> ‚Ä¢ üéØ <span id="targetLabel">No target</span></div>
          </div>

          <!-- Seats go here -->
          <div id="seats"></div>

          <!-- Panel stack (one active at a time) -->
          <div class="panelStack">
            <div id="lobbyPanel" class="panel">
              <div class="panelTitle">
                <b>Lobby</b>
                <span class="tiny muted" id="lobbyHost"></span>
              </div>
              <div class="row">
                <button id="startBtn" class="primary">Start Game</button>
                <span class="tiny muted" id="startHint"></span>
              </div>
            </div>

            <div id="endPanel" class="panel">
              <div class="panelTitle">
                <b>Game Over</b>
                <span class="tiny muted" id="endHost"></span>
              </div>
              <div id="endWinner" style="margin-top:4px;"></div>
              <div class="row" style="margin-top:10px;">
                <button id="rematchBtn" class="primary">Rematch</button>
                <span class="tiny muted" id="rematchHint"></span>
              </div>
            </div>

            <div id="mustCoupHint" class="panel">
              <div class="panelTitle">
                <b>Mandatory Coup</b>
                <span class="tiny muted">10+ coins</span>
              </div>If you have 10+ coins, you must Coup.
            </div>

            <div id="responsePanel" class="panel">
              <div class="panelTitle">
                <b>Response</b>
                <span class="tiny muted" id="responseHint"></span>
              </div>
              <div class="tiny warn" id="riskHint">‚ö†Ô∏è If you‚Äôre wrong, you lose 1 influence.</div>
              <div class="row" style="margin-top:10px;">
                <button id="passBtn" class="good">‚úÖ Pass</button>
                <button id="challengeBtn" class="risk">üü• Challenge</button>
                <button id="blockDukeBtn">üõ°Ô∏è Block (Duke)</button>
                <button id="blockContessaBtn">üõ°Ô∏è Block (Contessa)</button>
                <button id="blockCaptainBtn">üõ°Ô∏è Block (Captain)</button>
                <button id="blockAmbassadorBtn">üõ°Ô∏è Block (Ambassador)</button>
              </div>
            </div>

            <div id="losePanel" class="panel">
              <div class="panelTitle">
                <b>Lose Influence</b>
                <span class="tiny muted">Pick one</span>
              </div>
              <div class="row" id="loseButtons" style="margin-top:10px;"></div>
            </div>

            <div id="exchangePanel" class="panel">
              <div class="panelTitle">
                <b>Exchange</b>
                <span class="tiny muted" id="exchangeHint"></span>
              </div>
              <div class="row" id="exchangeButtons" style="margin-top:10px;"></div>
              <div class="row" style="margin-top:10px;">
                <button id="exchangeConfirmBtn" class="primary">Confirm Exchange</button>
              </div>
            </div>

            <div id="helpPanel" class="panel">
              <div class="panelTitle">
                <b>Quick Guide</b>
                <button id="helpCloseBtn" class="pill">Close</button>
              </div>
              <div class="tiny muted" style="line-height:1.55">
                <div><b>Actions</b>: Income (+1), Foreign Aid (+2, block Duke), Tax (+3, claim Duke), Steal (claim Captain; block Captain/Ambassador), Assassinate (pay 3, claim Assassin; block Contessa), Exchange (claim Ambassador), Coup (pay 7).</div>
                <div style="margin-top:8px;"><b>Challenges</b>: If they prove it, you lose 1 influence; otherwise they lose 1 and the action/block fails.</div>
                <div style="margin-top:8px;"><b>Rule</b>: At 10+ coins you must Coup.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sticky action bar -->
    <div class="actionBar">
      <div class="actionInner">
        <button id="incomeBtn">Income</button>
        <button id="aidBtn">Foreign Aid</button>
        <button id="taxBtn">üí∞ Tax</button>
        <button id="assassinateBtn">üó°Ô∏è Assassinate</button>
        <button id="stealBtn">ü™ô Steal</button>
        <button id="exchangeBtn">üîÑ Exchange</button>
        <button id="coupBtn" class="risk">Coup</button>
      </div>
    </div>

    <!-- Log drawer -->
    <div id="drawer">
      <div class="inner">
        <div class="row" style="justify-content:space-between; margin-bottom:10px;">
          <b>Log</b>
          <button id="drawerCloseBtn" class="pill">Close</button>
        </div>
        <div id="log"></div>
      </div>
    </div>

    <!-- Name modal -->
    <div id="nameModalBackdrop">
      <div id="nameModal">
        <h3>Your name</h3>
        <div class="muted tiny" style="margin-bottom:10px;">This updates instantly for everyone.</div>
        <input id="nameInput" maxlength="24" autocomplete="off" />
        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button id="nameCancelBtn" class="pill">Cancel</button>
          <button id="nameSaveBtn" class="primary">Save</button>
        </div>
      </div>
    </div>

    <script>
      const WS_URL = "ws://127.0.0.1:8080";

      const $turn = document.getElementById("turn");
      const $liveDot = document.getElementById("liveDot");
      const $targetHint = document.getElementById("targetHint");

      const $tableWrap = document.getElementById("tableWrap");
      const $seats = document.getElementById("seats");

      const $centerStatus = document.getElementById("centerStatus");
      const $meCoinsInline = document.getElementById("meCoinsInline");
      const $targetLabel = document.getElementById("targetLabel");

      const $incomeBtn = document.getElementById("incomeBtn");
      const $aidBtn = document.getElementById("aidBtn");
      const $taxBtn = document.getElementById("taxBtn");
      const $assassinateBtn = document.getElementById("assassinateBtn");
      const $stealBtn = document.getElementById("stealBtn");
      const $exchangeBtn = document.getElementById("exchangeBtn");
      const $coupBtn = document.getElementById("coupBtn");

      const $lobbyPanel = document.getElementById("lobbyPanel");
      const $lobbyHost = document.getElementById("lobbyHost");
      const $startBtn = document.getElementById("startBtn");
      const $startHint = document.getElementById("startHint");

      const $endPanel = document.getElementById("endPanel");
      const $endHost = document.getElementById("endHost");
      const $endWinner = document.getElementById("endWinner");
      const $rematchBtn = document.getElementById("rematchBtn");
      const $rematchHint = document.getElementById("rematchHint");

      const $mustCoupHint = document.getElementById("mustCoupHint");

      const $responsePanel = document.getElementById("responsePanel");
      const $responseHint = document.getElementById("responseHint");
      const $riskHint = document.getElementById("riskHint");
      const $passBtn = document.getElementById("passBtn");
      const $challengeBtn = document.getElementById("challengeBtn");
      const $blockDukeBtn = document.getElementById("blockDukeBtn");
      const $blockContessaBtn = document.getElementById("blockContessaBtn");
      const $blockCaptainBtn = document.getElementById("blockCaptainBtn");
      const $blockAmbassadorBtn = document.getElementById("blockAmbassadorBtn");

      const $losePanel = document.getElementById("losePanel");
      const $loseButtons = document.getElementById("loseButtons");

      const $exchangePanel = document.getElementById("exchangePanel");
      const $exchangeHint = document.getElementById("exchangeHint");
      const $exchangeButtons = document.getElementById("exchangeButtons");
      const $exchangeConfirmBtn = document.getElementById("exchangeConfirmBtn");

      const $helpPanel = document.getElementById("helpPanel");
      const $helpBtn = document.getElementById("helpBtn");
      const $helpCloseBtn = document.getElementById("helpCloseBtn");

      const $drawer = document.getElementById("drawer");
      const $drawerBtn = document.getElementById("drawerBtn");
      const $drawerCloseBtn = document.getElementById("drawerCloseBtn");
      const $log = document.getElementById("log");

      const $changeNameBtn = document.getElementById("changeNameBtn");
      const $leaveBtn = document.getElementById("leaveBtn");
      const $nameModalBackdrop = document.getElementById("nameModalBackdrop");
      const $nameInput = document.getElementById("nameInput");
      const $nameCancelBtn = document.getElementById("nameCancelBtn");
      const $nameSaveBtn = document.getElementById("nameSaveBtn");

      function getId() {
        let id = sessionStorage.getItem("coup_id");
        if (!id) {
          id = crypto.randomUUID();
          sessionStorage.setItem("coup_id", id);
        }
        return id;
      }
      function defaultName() { return "Player-" + Math.random().toString(16).slice(2, 6); }
      function getName() {
        let name = sessionStorage.getItem("coup_name");
        if (!name) {
          name = defaultName();
          sessionStorage.setItem("coup_name", name);
        }
        return name;
      }

      const myId = getId();
      let myName = getName();

      let ws = null;
      let lastState = null;

      // targeting
      let selectedTargetId = null;

      // private exchange stash (actor-only)
      let exchangeOptions = null;
      let exchangePicked = new Set();

      function send(obj) {
        if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj));
      }

      function connect() {
        ws = new WebSocket(WS_URL);
        ws.addEventListener("open", () => {
          send({ type: "join", id: myId, name: myName });
        });
        ws.addEventListener("message", (ev) => {
          const msg = JSON.parse(ev.data);

          if (msg.type === "state") {
            lastState = msg.state;
            render(msg.state);
          }

          if (msg.type === "private" && msg.kind === "exchangeOptions") {
            exchangeOptions = { keepCount: msg.keepCount, options: msg.options };
            exchangePicked = new Set();
            if (lastState) render(lastState);
          }
        });
      }

      function playerById(state, id) {
        return state.players?.find(p => p.id === id) || null;
      }
      function playerNameById(state, id) {
        return playerById(state, id)?.name || "Someone";
      }
      function myPlayer(state) {
        return playerById(state, myId);
      }

      // Log drawer
      function openDrawer(){ $drawer.classList.add("open"); }
      function closeDrawer(){ $drawer.classList.remove("open"); }
      $drawerBtn.onclick = () => ($drawer.classList.contains("open") ? closeDrawer() : openDrawer());
      $drawerCloseBtn.onclick = closeDrawer;

      // Help
      function openHelp() { $helpPanel.style.display = "block"; }
      function closeHelp() { $helpPanel.style.display = "none"; }
      $helpBtn.onclick = () => ($helpPanel.style.display === "none" ? openHelp() : closeHelp());
      $helpCloseBtn.onclick = closeHelp;

      // Name modal
      function openNameModal() {
        $nameInput.value = myName || "";
        $nameModalBackdrop.style.display = "flex";
        $nameInput.focus();
        $nameInput.select();
      }
      function closeNameModal() { $nameModalBackdrop.style.display = "none"; }
      $changeNameBtn.onclick = openNameModal;
      $nameCancelBtn.onclick = closeNameModal;
      $nameModalBackdrop.addEventListener("click", (e) => {
        if (e.target === $nameModalBackdrop) closeNameModal();
      });
      $nameSaveBtn.onclick = () => {
        const val = ($nameInput.value || "").trim().slice(0, 24);
        if (!val) return;
        myName = val;
        sessionStorage.setItem("coup_name", myName);
        send({ type: "rename", id: myId, name: myName });
        closeNameModal();
      };

      // Leave
      $leaveBtn.onclick = () => {
        send({ type: "leave", id: myId });
        try { ws.close(); } catch {}
        setTimeout(() => location.reload(), 100);
      };

      // Lobby start / rematch
      $startBtn.onclick = () => send({ type: "startGame" });
      $rematchBtn.onclick = () => send({ type: "rematch" });

      // Seat layouts for 2‚Äì10 opponents (you are always bottom fixed)
      function getOpponentSlots(nOpp) {
        // positions are percentages relative to tableWrap
        // We keep them around the top/left/right in a ring, expanding as count grows.
        const slots = {
          1: [ { left: 50, top: 16, anchor:"center" } ],
          2: [ { left: 30, top: 18, anchor:"center" }, { left: 70, top: 18, anchor:"center" } ],
          3: [ { left: 50, top: 14, anchor:"center" }, { left: 22, top: 32, anchor:"center" }, { left: 78, top: 32, anchor:"center" } ],
          4: [ { left: 28, top: 16, anchor:"center" }, { left: 72, top: 16, anchor:"center" }, { left: 16, top: 42, anchor:"center" }, { left: 84, top: 42, anchor:"center" } ],
          5: [ { left: 50, top: 12, anchor:"center" }, { left: 22, top: 22, anchor:"center" }, { left: 78, top: 22, anchor:"center" }, { left: 16, top: 44, anchor:"center" }, { left: 84, top: 44, anchor:"center" } ],
          6: [ { left: 24, top: 14, anchor:"center" }, { left: 50, top: 12, anchor:"center" }, { left: 76, top: 14, anchor:"center" }, { left: 14, top: 38, anchor:"center" }, { left: 86, top: 38, anchor:"center" }, { left: 50, top: 32, anchor:"center" } ],
          7: [ { left: 18, top: 14, anchor:"center" }, { left: 38, top: 10, anchor:"center" }, { left: 62, top: 10, anchor:"center" }, { left: 82, top: 14, anchor:"center" }, { left: 12, top: 38, anchor:"center" }, { left: 88, top: 38, anchor:"center" }, { left: 50, top: 30, anchor:"center" } ],
          8: [ { left: 16, top: 12, anchor:"center" }, { left: 34, top: 9, anchor:"center" }, { left: 50, top: 8, anchor:"center" }, { left: 66, top: 9, anchor:"center" }, { left: 84, top: 12, anchor:"center" }, { left: 10, top: 38, anchor:"center" }, { left: 90, top: 38, anchor:"center" }, { left: 50, top: 30, anchor:"center" } ],
          9: [ { left: 14, top: 12, anchor:"center" }, { left: 30, top: 9, anchor:"center" }, { left: 45, top: 7, anchor:"center" }, { left: 55, top: 7, anchor:"center" }, { left: 70, top: 9, anchor:"center" }, { left: 86, top: 12, anchor:"center" }, { left: 10, top: 36, anchor:"center" }, { left: 90, top: 36, anchor:"center" }, { left: 50, top: 28, anchor:"center" } ],
        };
        return slots[Math.max(1, Math.min(9, nOpp))];
      }

      function seatStyle(slot) {
        const w = $tableWrap.clientWidth;
        // slightly tighter on narrow screens
        const isNarrow = w < 560;
        const scale = isNarrow ? 0.92 : 1.0;
        const tx = slot.anchor === "center" ? "-50%" : "0%";
        return `
          left:${slot.left}%;
          top:${slot.top}%;
          transform: translate(${tx}, -50%) scale(${scale});
        `;
      }

      function setSelectedTarget(state, id) {
        selectedTargetId = id;
        const label = id ? playerNameById(state, id) : "No target";
        $targetLabel.textContent = label;
      }

      function render(state) {
        const phase = state.phase;
        const isLobby = phase === "lobby";
        const isEnded = phase === "ended";
        const me = myPlayer(state);
        const isMyTurn = state.turnPlayerId === myId;

        $liveDot.classList.toggle("live", !isLobby && !isEnded);
        $turn.textContent = isLobby
          ? "Lobby"
          : isEnded
            ? "Game over"
            : (state.turnPlayerId ? `Turn: ${playerNameById(state, state.turnPlayerId)}` : "Turn: ‚Äî");

        $targetHint.textContent = isLobby ? "Waiting for host‚Ä¶" : isEnded ? "Rematch when ready." : "Tap a player to target.";

        // Update inline coins + target
        $meCoinsInline.textContent = me?.coins ?? 0;

        // Panels
        $lobbyPanel.style.display = isLobby ? "block" : "none";
        $endPanel.style.display = isEnded ? "block" : "none";
        // help panel toggled separately

        if (isLobby) {
          const hostName = playerNameById(state, state.hostId);
          $lobbyHost.textContent = `Host: ${hostName}`;
          const isHost = state.hostId === myId;
          const enoughPlayers = (state.players || []).length >= 2;

          $startBtn.style.display = isHost ? "inline-block" : "none";
          $startBtn.disabled = !enoughPlayers;

          $startHint.textContent = isHost
            ? (enoughPlayers ? "Ready when you are." : "Need at least 2 players.")
            : "Waiting for host‚Ä¶";
        }

        if (isEnded) {
          const hostName = playerNameById(state, state.hostId);
          $endHost.textContent = `Host: ${hostName}`;
          const winnerName = state.winnerId ? playerNameById(state, state.winnerId) : "Someone";
          $endWinner.innerHTML = `<b>${winnerName}</b> wins.`;

          const isHost = state.hostId === myId;
          const enoughPlayers = (state.players || []).length >= 2;

          $rematchBtn.style.display = isHost ? "inline-block" : "none";
          $rematchBtn.disabled = !enoughPlayers;

          $rematchHint.textContent = isHost
            ? (enoughPlayers ? "Start a new game with the same players." : "Need at least 2 players.")
            : "Waiting for host‚Ä¶";
        }

        // Build seats
        $seats.innerHTML = "";

        const players = (state.players || []);
        const others = players.filter(p => p.id !== myId);
        const oppSlots = getOpponentSlots(others.length);

        // Ensure selected target stays valid
        if (selectedTargetId && !others.some(p => p.id === selectedTargetId && p.alive && !isLobby && !isEnded)) {
          selectedTargetId = null;
        }

        // Auto-pick target when game starts (first alive other)
        if (!isLobby && !isEnded) {
          if (!selectedTargetId) {
            const firstAliveOther = others.find(p => p.alive);
            if (firstAliveOther) setSelectedTarget(state, firstAliveOther.id);
            else setSelectedTarget(state, null);
          } else {
            setSelectedTarget(state, selectedTargetId);
          }
        } else {
          setSelectedTarget(state, null);
        }

        // Render opponent seats in join order (others array already ordered from state)
        for (let i = 0; i < others.length; i++) {
          const p = others[i];
          const slot = oppSlots[i] || oppSlots[oppSlots.length - 1];
          const isDead = !p.alive && !isLobby;

          const seat = document.createElement("div");
          seat.className = "seat" + (isDead ? " dead" : "") + (selectedTargetId === p.id ? " selected" : "");
          seat.style.cssText = seatStyle(slot);

          const hostTag = state.hostId === p.id ? `<span class="tag">host</span>` : "";
          const turnTag = (!isLobby && !isEnded && p.id === state.turnPlayerId) ? `<span class="tag">turn</span>` : "";

          seat.innerHTML = `
            <div class="seatTop">
              <div class="seatName">${p.name}</div>
              <div style="display:flex; gap:6px; align-items:center;">${hostTag}${turnTag}</div>
            </div>
            <div class="seatMeta">
              <span class="muted">Coins</span>
              <span class="coinStack">ü™ô <b>${p.coins ?? 0}</b></span>
            </div>
            <div class="infs">
              ${(p.influence || []).map(c => {
                if (c.revealed) return `<div class="infCard revealed" title="${c.role}">${c.role[0]}</div>`;
                return `<div class="infCard" title="Hidden">?</div>`;
              }).join("")}
            </div>
          `;

          seat.onclick = () => {
            if (isLobby || isEnded) return;
            if (!p.alive) return;
            setSelectedTarget(state, p.id);
            render(state);
          };

          $seats.appendChild(seat);
        }

        // Render YOUR seat (bottom)
        const you = document.createElement("div");
        you.className = "seat you";
        const aliveCards = (me?.influence || []).filter(c => !c.revealed).length;
        const turnText = isLobby ? "In lobby" : isEnded ? "Finished" : (isMyTurn ? "Your turn" : "Waiting");
        you.innerHTML = `
          <div class="seatTop">
            <div class="seatName">${me?.name || "You"}</div>
            <span class="tag">${turnText}</span>
          </div>
          <div class="youMetaLine">
            <span class="coinStack">ü™ô <b>${me?.coins ?? 0}</b></span>
            <span class="muted">Influence: <b>${aliveCards}</b></span>
            <span class="muted">Target: <b>${selectedTargetId ? playerNameById(state, selectedTargetId) : "‚Äî"}</b></span>
          </div>
          <div class="infs">
            ${(me?.influence || []).map(c => {
              if (c.revealed) return `<div class="infCard revealed" title="${c.role}">${c.role}</div>`;
              return `<div class="infCard" title="${c.role}">${c.role}</div>`;
            }).join("")}
          </div>
        `;
        $seats.appendChild(you);

        // Log
        $log.textContent = (state.log || []).join("\n");

        // Action enabling
        const canAct = !isLobby && !isEnded && isMyTurn && me && me.alive && !state.pendingAction;
        const mustCoup = !!(me && me.coins >= 10);
        $mustCoupHint.style.display = (!isLobby && !isEnded && mustCoup) ? "block" : "none";

        $incomeBtn.disabled = !canAct || mustCoup;
        $aidBtn.disabled = !canAct || mustCoup;
        $taxBtn.disabled = !canAct || mustCoup;
        $assassinateBtn.disabled = !canAct || mustCoup || (me && me.coins < 3);
        $stealBtn.disabled = !canAct || mustCoup;
        $exchangeBtn.disabled = !canAct || mustCoup;
        $coupBtn.disabled = !canAct || (me && me.coins < 7);

        renderResponsePanels(state, isLobby || isEnded);
        renderExchangePanel(state, isLobby || isEnded);
      }

      function sendAction(actionType) {
        const targetId = selectedTargetId || null;
        send({ type: "action", id: myId, actionType, targetId });
      }
      function sendResponse(responseType, payload) {
        send({ type: "response", id: myId, responseType, payload: payload || {} });
      }

      function renderExchangePanel(state, disabled) {
        $exchangePanel.style.display = "none";
        if (disabled) return;

        const pending = state.pendingAction;
        if (!pending) return;

        if (pending.type !== "exchange" || pending.stage !== "awaitingChoice") return;
        if (pending.actorId !== myId) return;

        const keepCount = pending.keepCount || (exchangeOptions?.keepCount ?? 2);
        if (!exchangeOptions || exchangeOptions.keepCount !== keepCount) return;

        $exchangeButtons.innerHTML = "";
        for (const opt of exchangeOptions.options) {
          const b = document.createElement("button");
          const picked = exchangePicked.has(opt.id);
          b.textContent = opt.role + (picked ? " ‚úì" : "");
          if (picked) b.classList.add("primary");
          b.onclick = () => {
            const next = new Set(exchangePicked);
            if (next.has(opt.id)) next.delete(opt.id);
            else {
              if (next.size >= keepCount) return;
              next.add(opt.id);
            }
            exchangePicked = next;
            renderExchangePanel(state, disabled);
          };
          $exchangeButtons.appendChild(b);
        }

        $exchangeHint.textContent = `Pick ${keepCount} card(s) to keep.`;
        $exchangeConfirmBtn.disabled = exchangePicked.size !== keepCount;
        $exchangeConfirmBtn.onclick = () => {
          sendResponse("exchangeChoice", { keep: Array.from(exchangePicked) });
          exchangeOptions = null;
          exchangePicked = new Set();
          $exchangePanel.style.display = "none";
        };

        $exchangePanel.style.display = "block";
      }

      function renderResponsePanels(state, disabled) {
        const pending = state.pendingAction;

        $responsePanel.style.display = "none";
        $losePanel.style.display = "none";
        $riskHint.style.display = "none";
        if (disabled) return;
        if (!pending) return;

        // 1) Lose influence choice
        if (pending.type === "loseInfluence" && pending.playerId === myId) {
          const me = myPlayer(state);
          $loseButtons.innerHTML = "";
          (me.influence || []).forEach((c, i) => {
            if (!c.revealed) {
              const b = document.createElement("button");
              b.textContent = `Lose ${c.role}`;
              b.className = "risk";
              b.onclick = () => sendResponse("loseInfluence", { cardIndex: i });
              $loseButtons.appendChild(b);
            }
          });
          $losePanel.style.display = "block";
          return;
        }

        const iAmPendingResponder =
          pending.responders &&
          Object.prototype.hasOwnProperty.call(pending.responders, myId) &&
          pending.responders[myId] === "pending";

        const iAmAssassinationTargetBlock =
          pending.type === "assassinate" &&
          pending.stage === "awaitingBlock" &&
          pending.targetId === myId;

        const iAmStealTargetBlock =
          pending.type === "steal" &&
          pending.stage === "awaitingBlock" &&
          pending.targetId === myId;

        if (!iAmPendingResponder && !iAmAssassinationTargetBlock && !iAmStealTargetBlock) return;

        const showPass = true;
        const showChallenge =
          pending.stage === "awaitingChallenge" ||
          pending.stage === "awaitingChallengeBlock";

        const showBlockDuke =
          pending.type === "foreign_aid" && pending.stage === "awaitingBlock";

        const showBlockContessa =
          pending.type === "assassinate" &&
          pending.stage === "awaitingBlock" &&
          pending.targetId === myId;

        const showBlockCaptain =
          pending.type === "steal" &&
          pending.stage === "awaitingBlock" &&
          pending.targetId === myId;

        const showBlockAmbassador =
          pending.type === "steal" &&
          pending.stage === "awaitingBlock" &&
          pending.targetId === myId;

        $passBtn.style.display = showPass ? "inline-block" : "none";
        $challengeBtn.style.display = showChallenge ? "inline-block" : "none";
        $blockDukeBtn.style.display = showBlockDuke ? "inline-block" : "none";
        $blockContessaBtn.style.display = showBlockContessa ? "inline-block" : "none";
        $blockCaptainBtn.style.display = showBlockCaptain ? "inline-block" : "none";
        $blockAmbassadorBtn.style.display = showBlockAmbassador ? "inline-block" : "none";

        const actorName = playerNameById(state, pending.actorId);

        if (pending.type === "tax" && pending.stage === "awaitingChallenge") {
          $responseHint.textContent = `Do you believe ${actorName} has Duke?`;
          $riskHint.style.display = "block";
        } else if (pending.type === "steal" && pending.stage === "awaitingChallenge") {
          $responseHint.textContent = `Do you believe ${actorName} has Captain?`;
          $riskHint.style.display = "block";
        } else if (pending.type === "exchange" && pending.stage === "awaitingChallenge") {
          $responseHint.textContent = `Do you believe ${actorName} has Ambassador?`;
          $riskHint.style.display = "block";
        } else {
          $responseHint.textContent = "Make your choice.";
        }

        $responsePanel.style.display = "block";
      }

      // actions
      $incomeBtn.onclick = () => sendAction("income");
      $aidBtn.onclick = () => sendAction("foreign_aid");
      $taxBtn.onclick = () => sendAction("tax");
      $assassinateBtn.onclick = () => sendAction("assassinate");
      $stealBtn.onclick = () => sendAction("steal");
      $exchangeBtn.onclick = () => sendAction("exchange");
      $coupBtn.onclick = () => sendAction("coup");

      // responses
      $passBtn.onclick = () => sendResponse("pass");
      $challengeBtn.onclick = () => sendResponse("challenge");
      $blockDukeBtn.onclick = () => sendResponse("block", { role: "Duke" });
      $blockContessaBtn.onclick = () => sendResponse("block", { role: "Contessa" });
      $blockCaptainBtn.onclick = () => sendResponse("block", { role: "Captain" });
      $blockAmbassadorBtn.onclick = () => sendResponse("block", { role: "Ambassador" });

      connect();
    </script>
  </body>
</html>